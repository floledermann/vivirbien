{% extends "resources/base.html" %}
{% load i18n %}

{% block extra_head %}
<script src="{{MEDIA_URL}}js/jquery-1.3.2.js" type="text/javascript"></script>
<script src="{{MEDIA_URL}}js/urlify.js" type="text/javascript"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/OpenLayers-2.8/OpenLayers.js"></script>
<script type="text/javascript" src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script>
<style type="text/css">
.widget {
    display: none;
}
.widget .map {
    height: 340px;
}
</style>
{{ form.media }}
{{ formset.media }}

<script type="text/javascript">

var editor_lookup = {
    'location': function(el) {
        widget = $('#widget-location');
        widget.insertAfter(el);
        widget.show();

        if (!widget.data('isInitialized')) {
	        map = new OpenLayers.Map (widget.find('.map').get(0), {
		        controls:[
		            new OpenLayers.Control.Navigation(),
		            new OpenLayers.Control.PanZoomBar(),
		            new OpenLayers.Control.ScaleLine(),
		            //new OpenLayers.Control.LayerSwitcher(),
		            new OpenLayers.Control.MousePosition(),
		            new OpenLayers.Control.Attribution()],
		        maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
		                    maxResolution: 156543.0399,
		        numZoomLevels: 19,
		        units: 'm',
		        projection: new OpenLayers.Projection("EPSG:900913"),
                //projection: new OpenLayers.Projection("EPSG:4326"),
                displayProjection: new OpenLayers.Projection("EPSG:4326")
	        } );
	        
	        layer_osm = new OpenLayers.Layer.OSM.Mapnik("OpenStreetMap");
	        layer_osm.attribution = 'Map ' + layer_osm.attribution;
	        map.addLayer(layer_osm);
	        
		    layer_vector = new OpenLayers.Layer.Vector("Vectors", {
		        projection: new OpenLayers.Projection("EPSG:4326"),
		    });		    
		    map.addLayer(layer_vector);
		    
		    var style = {
                externalGraphic: "{{MEDIA_URL}}images/marker.png",
                graphicWidth: 21,
                graphicHeight: 25,
                graphicXOffset: -10,
                graphicYOffset: -25,
                graphicTitle: 'Current Location',
                cursor: 'pointer',
                graphicOpacity:0.7
            }
            
            var marker = null;
            var lonLat = new OpenLayers.LonLat(16.35, 48.2).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
            
		    var value = $(el).html();
		    if (value.startsWith("lonlat:")) {
		      try {
		          value = value.substring(7);
		          value = value.split(",");
		          lonLat = new OpenLayers.LonLat(parseFloat(value[0]), parseFloat(value[1])).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
                  marker = new OpenLayers.Feature.Vector(
                     new OpenLayers.Geometry.Point(parseFloat(value[0]), parseFloat(value[1])).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
                     {title: 'Location'},
                     style);
                  layer_vector.addFeatures([marker]);
               }
               catch(ex) {
                    // fail silently in case of parse error
               }
		    }
		    
            map.setCenter (lonLat, 12);
		    
		    /*
		    var control = new OpenLayers.Control.DrawFeature(layer_vector,
                                OpenLayers.Handler.Point, {
                                    featureAdded: function(feature) {
                                            if (marker) {
                                                layer_vector.destroyFeatures([marker]);
                                            }
                                            marker = feature;
                                            
                                            p2 = feature.geometry.transform(map.getProjectionObject(), new OpenLayers.Projection("EPSG:4326"));
                                            $(el).html('lonlat:' + p2.x + ',' + p2.y);
                                        }
                                    });
            */
            
 	        var control = new OpenLayers.Control();
			OpenLayers.Util.extend(control, {
			    draw: function () {
			        // this Handler.Box will intercept the shift-mousedown
			        // before Control.MouseDefault gets to see it
			        this.click_handler = new OpenLayers.Handler.Click( control, {
			             //pixelTolerance: 20,
			            click: function(ev){
                            lonLat = this.map.getLonLatFromPixel(ev.xy);
				            if (!lonLat) { 
				                // map has not yet been properly initialized
				                return;
				            }    
				            if (this.displayProjection) {
				                lonLat.transform(this.map.getProjectionObject(), 
				                                 this.displayProjection );
				            }      
			                $(el).html('lonlat:' + lonLat.lon + ',' + lonLat.lat);
			                
			                if (marker) {
			                     layer_vector.destroyFeatures([marker]);
			                }
		                     marker = new OpenLayers.Feature.Vector(
		                         new OpenLayers.Geometry.Point(lonLat.lon, lonLat.lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
		                         {title: 'Location'},
                                 style);
		                     layer_vector.addFeatures([marker]);
			            }});
			        this.click_handler.activate();
			    }
			});
			map.addControl(control);
			control.activate();	        
	        
	        widget.data('isInitialized', true);
        }
    }
}

jQuery(function($) {
    $('#id_shortname').change(function() {
        this._dirty = true;
    });
    $('#id_name').keyup(function() {
        var el = $('#id_shortname');
        if (! el[0]._dirty) {
            el.val(URLify($(this).val(), 100));
        }
    });
    
    /*
    $('input[type=text][id$=-key]').change(function() {
        var key_field = $(this);
        var key = key_field.val();
                
        var widget = editor_lookup[key];
        if (widget) {
	        var value_field_id = this.id.substring(0, this.id.indexOf('-key')) + '-value';
	        var value_field = $('#' + value_field_id);
	        
	        value_field.after('<div class="value-widget">' + widget + '</div>');           
            //value_field.css({'display': 'none'});
        }
    });
    */
    
    $('td.edit-value textarea').focus(function() {
        $('.widget').hide();
        var key = $(this).parents('tr').find('td.edit-key input').val();
        var widget_func = editor_lookup[key];
        if (widget_func) {
            widget_func(this);
        }
        
    });
    
    
    
});
</script>
{% endblock %}

{% block resources_content %}
{% include "resources/includes/actions.html" %}
{% if resource %}
<h1>{{ resource.name }}</h1>
{% else %}
<h1>{% trans "New resource" %}</h1>
{% endif %}

<form method="post" action="{% url resources_edit key=resource.shortname %}" autocomplete="off">
<table>
{{ form.as_table }}
</table>

{% if formset %}
{{ formset.management_form }}
<table>
{% for form in formset.forms %}
{% if forloop.first %}
<tr>
{% for field in form.visible_fields %}
        <th>{{ field.label }}</th>
{% endfor %}
</tr>
{% endif %}
<tr>
    {% for field in form.visible_fields %}
        <td class="edit-{{field.name}}">{{field.errors}}{{ field }}</td>
    {% endfor %}
    <td class="hidden">
    {% for field in form.hidden_fields %}
        {% if field.is_hidden %} {{ field }} {% endif %}
    {% endfor %}
    </td>
</tr>
{% endfor %}
</table>
{% endif %}

{% if tag_help %}
<div class="actions">
{% trans "Help:" %} 
{% for link in tag_help %}
<a href="{{link.1}}">{{link.0}}</a>
{% if not forloop.last %} | {% endif %}
{% endfor %}
</div>
{% endif %}

<button type="submit">{% trans "Save" %}</button>
<button name="action" value="add_tag" type="submit">{% trans "Save and continue" %}</button>

{% if resource %}
<a class="action" href="{% url resources_resource key=resource.shortname %}">{% trans "Cancel" %}</a>
{% else %}
<a class="action" href="{% url resources_list %}">{% trans "Cancel" %}</a>
{% endif %}

</form>

<div class="widget" id="widget-location">
<!--
<button class="button-lookup-address">{% trans "Look up from address" %}</button>
-->
<div class="map"></div>
</div>

<div class="widget" id="widget-address">
<button class="button-add-location">{% trans "Add location tag for this address" %}</button>
<div class="map"></div>
</div>

{% endblock %}